
#define Wr(reg, val) writel(val, reg)
#define Wr_reg_bits(reg, val, start, len) \
   writel(((readl(reg) & ~(((1L<<(len))-1)<<(start))) | ((uint32_t)(val) << (start))), reg)

static const int lpf2_osr192[] = {
	0x00050b, 0xfff002, 0x0002c7, 0x003c16, 0xffa7f7,
	0xffc89f, 0x010b35, 0xff516f, 0xfebd9a, 0x0290e8,
	0xff5a6d, 0xfc61f8, 0x05649b, 0x000000, 0xf46d02,
	0x11c6cc, 0x2eb731, 0x11c6cc, 0xf46d02, 0x000000,
	0x05649b, 0xfc61f8, 0xff5a6d, 0x0290e8, 0xfebd9a,
	0xff516f, 0x010b35, 0xffc89f, 0xffa7f7, 0x003c16,
	0x0002c7, 0xfff002, 0x00050b
};
static const int lpf1_mode1[] = {
	0x000014, 0xffffb2, 0xfffed9, 0xfffdce, 0xfffd45,
	0xfffe32, 0x000147, 0x000645, 0x000b86, 0x000e21,
	0x000ae3, 0x000000, 0xffeece, 0xffdca8, 0xffd212,
	0xffd7d1, 0xfff2a7, 0x001f4c, 0x0050c2, 0x0072aa,
	0x006ff1, 0x003c32, 0xffdc4e, 0xff6a18, 0xff0fef,
	0xfefbaf, 0xff4c40, 0x000000, 0x00ebc8, 0x01c077,
	0x02209e, 0x01c1a4, 0x008e60, 0xfebe52, 0xfcd690,
	0xfb8fa5, 0xfba498, 0xfd9812, 0x0181ce, 0x06f5f3,
	0x0d112f, 0x12a958, 0x169686, 0x18000e, 0x169686,
	0x12a958, 0x0d112f, 0x06f5f3, 0x0181ce, 0xfd9812,
	0xfba498, 0xfb8fa5, 0xfcd690, 0xfebe52, 0x008e60,
	0x01c1a4, 0x02209e, 0x01c077, 0x00ebc8, 0x000000,
	0xff4c40, 0xfefbaf, 0xff0fef, 0xff6a18, 0xffdc4e,
	0x003c32, 0x006ff1, 0x0072aa, 0x0050c2, 0x001f4c,
	0xfff2a7, 0xffd7d1, 0xffd212, 0xffdca8, 0xffeece,
	0x000000, 0x000ae3, 0x000e21, 0x000b86, 0x000645,
	0x000147, 0xfffe32, 0xfffd45, 0xfffdce, 0xfffed9,
	0xffffb2, 0x000014,
};

static const int lpf3_mode1[] = {
	0x000000, 0x000081, 0x000000, 0xfffedb, 0x000000,
	0x00022d, 0x000000, 0xfffc46, 0x000000, 0x0005f7,
	0x000000, 0xfff6eb, 0x000000, 0x000d4e, 0x000000,
	0xffed1e, 0x000000, 0x001a1c, 0x000000, 0xffdcb0,
	0x000000, 0x002ede, 0x000000, 0xffc2d1, 0x000000,
	0x004ebe, 0x000000, 0xff9beb, 0x000000, 0x007dd7,
	0x000000, 0xff633a, 0x000000, 0x00c1d2, 0x000000,
	0xff11d5, 0x000000, 0x012368, 0x000000, 0xfe9c45,
	0x000000, 0x01b252, 0x000000, 0xfdebf6, 0x000000,
	0x0290b8, 0x000000, 0xfcca0d, 0x000000, 0x041d7c,
	0x000000, 0xfa8152, 0x000000, 0x07e9c6, 0x000000,
	0xf28fb5, 0x000000, 0x28b216, 0x3fffde, 0x28b216,
	0x000000, 0xf28fb5, 0x000000, 0x07e9c6, 0x000000,
	0xfa8152, 0x000000, 0x041d7c, 0x000000, 0xfcca0d,
	0x000000, 0x0290b8, 0x000000, 0xfdebf6, 0x000000,
	0x01b252, 0x000000, 0xfe9c45, 0x000000, 0x012368,
	0x000000, 0xff11d5, 0x000000, 0x00c1d2, 0x000000,
	0xff633a, 0x000000, 0x007dd7, 0x000000, 0xff9beb,
	0x000000, 0x004ebe, 0x000000, 0xffc2d1, 0x000000,
	0x002ede, 0x000000, 0xffdcb0, 0x000000, 0x001a1c,
	0x000000, 0xffed1e, 0x000000, 0x000d4e, 0x000000,
	0xfff6eb, 0x000000, 0x0005f7, 0x000000, 0xfffc46,
	0x000000, 0x00022d, 0x000000, 0xfffedb, 0x000000,
	0x000081, 0x000000,
};

int enable_pdm(void)
{
	unsigned int i = 0;

	if (0 == (readl(HHI_MPLL_CNTL) & (1<<30))) {
		dbg_print("enable_pdm no MPLL clk, nothing can be done\n", 0);
		return 0;
	}

	i = readl(EE_AUDIO_CLK_PDMIN_CTRL1);
	if (0 == (i & (1<<31))) {
		dbg_print("detect pdm clk gate off\n", 0);
		return 0;
	}

	i = (1<<30) | (1<<28) | (0x20<<20) |(3<<16) | (31<<8) | 0x4;
	Wr(EE_AUDIO_POW_DET_CTRL0, i);
	//writel(0x70000, EE_AUDIO_POW_DET_TH_HI);
	//writel(0x16000, EE_AUDIO_POW_DET_TH_LO);
	/* configure PDM */
	//Wr_reg_bits(EE_AUDIO_CLK_PDMIN_CTRL1, 1, 31, 1);//pdm sysclk gate
	Wr_reg_bits(EE_AUDIO_CLK_PDMIN_CTRL0, 1, 31, 1);//pdm dclk gate
	Wr_reg_bits(EE_AUDIO_CLK_GATE_EN, 1, 19, 1);//pwr detect clk gate
	Wr_reg_bits(EE_AUDIO_CLK_GATE_EN, 1, 12, 1);//A ToDDR clk gate
	Wr_reg_bits(EE_AUDIO_CLK_GATE_EN, 1, 1, 1);//pdm clk gate
	Wr_reg_bits(EE_AUDIO_CLK_GATE_EN, 1, 0, 1);//ddr arb gate

	Wr(PDM_CLKG_CTRL, 1);
	Wr(PDM_CTRL, 0x4000ffff);   //start pdm reset fifo
	Wr(PDM_CHAN_CTRL, 0x12121212);
	Wr(PDM_CHAN_CTRL1, 0x12121212);
	Wr(PDM_HCIC_CTRL1,0x9c780187);
	Wr(PDM_F1_CTRL, 0x80012057);
	Wr(PDM_F2_CTRL, 0x80002021);
	Wr(PDM_F3_CTRL, 0x80012075);
	Wr(PDM_HPF_CTRL, 0x800d8000);
	Wr(PDM_COEFF_ADDR, 0); //0xed

	for (i=0; i < (sizeof(lpf1_mode1)/sizeof(int)); i++)
		Wr(PDM_COEFF_DATA, lpf1_mode1[i]);
	for (i=0; i < (sizeof(lpf2_osr192)/sizeof(int)); i++)
		Wr(PDM_COEFF_DATA, lpf2_osr192[i]);
	for (i=0; i < (sizeof(lpf3_mode1)/sizeof(int)); i++)
		Wr(PDM_COEFF_DATA, lpf3_mode1[i]);
	Wr(EE_AUDIO_ARB_CTRL, 0x800000EF);
	Wr(EE_AUDIO_TODDR_A_CTRL0, 0x41F84);//set A-toDDR fmt
	Wr(EE_AUDIO_TODDR_A_CTRL1, 0x3F0200);
	//Wr(EE_AUDIO_TODDR_A_START_ADDR, 0x5500000);
	//Wr(EE_AUDIO_TODDR_A_FINISH_ADDR, 0x5700000);
	Wr_reg_bits(PDM_CTRL, 1, 16, 0); //hold reset pdm fifo
	Wr_reg_bits(PDM_CTRL, 1, 16, 1); //release reset pdm fifo
	Wr_reg_bits(EE_AUDIO_TODDR_A_CTRL0, 1, 31, 1);//start A-toDDR
	Wr_reg_bits(PDM_CTRL, 1, 31, 1); //start pdm capture
	Wr_reg_bits(EE_AUDIO_POW_DET_CTRL0, 1, 31, 1);//enable audio pwr detect

	dbg_print("bl30 set pdm done ", 0);
	return 1;
}

unsigned get_aud_pwr_val(void)
{
	return readl(EE_AUDIO_POW_DET_VALUE);
}
